# .gitlab/templates/staging-template.yml
# This template is used for staging deployments in GitLab CI/CD

spec:
  inputs:
    job_suffix:
      description: "Suffix for job naming"
    env_name:
      description: "Deployment environment"
    ssh_user:
      description: "SSH user"
    ssh_host:
      description: "SSH host"
    ssh_port:
      description: "SSH port"
    environment_name:
      description: "GitLab environment"
    environment_url:
      description: "Env URL"
---
build-$[[ inputs.job_suffix ]]:
  stage: build
  image: node:22
  script:
    - npm install
    - npm run build
  # artifacts:
  #   paths: [dist/]

ssh-test-$[[ inputs.job_suffix ]]:
  stage: test
  needs: 
    - job: build-$[[ inputs.job_suffix ]]
      artifacts: true

  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
  script:
    # - scp -P "$[[ inputs.ssh_port ]]" -r dist/  "$[[ inputs.ssh_user ]]@$[[ inputs.ssh_host ]]:~/regulatory-deploy/"
    # - echo "âœ… Files copied successfully"
    - echo "ðŸ” Checking SSH connection to DMZ server..."
    - ssh -p "$[[ inputs.ssh_port ]]" "$[[ inputs.ssh_user ]]@$[[ inputs.ssh_host ]]"
    - echo "âœ… SSH connection successful"



deploy-$[[ inputs.job_suffix ]]:
  stage: deploy
  image: docker:latest # Specifies the main Docker image for the job

  variables:
    DOCKER_HOST: tcp://docker:2375 # Connects to the DinD service
    DOCKER_TLS_CERTDIR: "" # Disables TLS for simplicity in this example

  services:
    - docker:dind # Starts the Docker-in-Docker service

  before_script:
    - docker info
    - apk add --no-cache openssh-client bash gzip docker-cli docker-cli-compose
    - echo "ðŸ” Setting up SSH keys for deployment..."
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
    - chmod 600 ~/.ssh/known_hosts
    - chmod +x .gitlab/scripts/deploy_to_dmz.sh

  script:
    - .gitlab/scripts/deploy_to_dmz.sh
  environment:
    name: $[[ inputs.environment_name ]]
    url: $[[ inputs.environment_url ]]
  when: manual
